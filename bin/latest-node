#!/usr/bin/env bash

source "${0%/*}/../bash/functions.sh"
source "${0%/*}/../bash/checksums.sh"

dirs=(bin include lib share)
src_dir="/tmp"
install_dir="$HOME/.local"

gpg_keys=(
    9554F04D7259F04124DE6B476D5A82AC7E37093B
    94AE36675C464D64BAFA68DD7434390BDBE9B9C5
    0034A06D9D9B0064CE8ADF6BF1747F4AD2306D93
    FD3A5288F042B6850C66B31F09FE44734EB7990E
    71DCFD284A79C3B38668286BC97EC7A07EDE3FC1
    DD8F2338BAE7501E3DD5AC78C273792F7D83545D
    C4F0DFFF4E8C1A8236409D08E73BC641CC11F4C8
    B9AE9905FFD7803F25714661B63B535A4C206CA9
)

checksums_url="https://nodejs.org/dist/latest/SHASUMS256.txt.asc"
checksums_file="SHASUMS256.txt.asc"

node_url=""
node_version=""
node_archive=""
node_src_dir=""


function import_gpg_keys()
{
	local key
    log "Importing authorized GPG keys"

	for key in "${gpg_keys[@]}"; do
    	gpg --keyserver pool.sks-keyservers.net --recv-keys $key || return $?
	done
}

function download_checksums()
{
	log "Downloading $checksums_url into $src_dir ..."
	download "$checksums_url" "$src_dir/$checksums_file" || return $?
}

function verify_checksums()
{
	log "Verifying $checksums_file ..."
	gpg --verify "$src_dir/$checksums_file" || return $?
}

#
# Extract latest node version
#
function extract_node_version()
{
    local file="$src_dir/$checksums_file"
    local pattern="linux-x64.tar.xz"
    
    log "Extract latest version from $checksums_file ..."
    
    grep -q "$pattern" "$file" || return $? 

    IFS=" " read node_archive_checksum node_archive <<< "$(grep "$pattern" "$file")"
    IFS="-" read _ node_version _ <<< "$node_archive"
}


#
# Download the Node archive
#
function download_node()
{
    node_url="https://nodejs.org/dist/latest/$node_archive"
    
    log "Downloading $node_url into $src_dir ..."
	
    download "$node_url" "$src_dir/$node_archive" || return $?
}


function verify_node()
{
    log "Verifying $node_archive ..."
    verify_checksum "$src_dir/$node_archive" sha256 "$node_archive_checksum" || return $?
}

#
# Extract the Node archive
#
function extract_node()
{
    node_src_dir="$(sed "s/\.tar\.xz//" <<< "$node_archive")"
    
    log "Extracting $node_archive to $src_dir/$node_src_dir ..."
	
    extract "$src_dir/$node_archive" "$src_dir" || return $?
}

#
# Installs Node into $install_dir
#
function install_node()
{
    local dir

    log "Installing node $node_version ..."	

    for dir in $dirs; do 
        mkdir -p "$install_dir/$dir" || return $?
        cp -R $src_dir/$node_src_dir/$dir/* "$install_dir/$dir/" || return $?
    done
}


import_gpg_keys || fail "Import of verified GPG keys failed!"

download_checksums || fail "Download of $checksums_url failed!"

verify_checksums || fail "Verification of $checksums_file failed!"

extract_node_version || fail "Extracting of latest node version from $checksums_file failed!"

download_node || fail "Download of $node_url failed!"

verify_node || fail "Verification of $node_archive failed!"

extract_node || fail "Unpacking of $node_archive failed!"

install_node || fail "Installation of node $node_version failed!"

log "Successfully installed node $node_version into $install_dir"

