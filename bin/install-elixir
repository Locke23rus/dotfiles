#!/usr/bin/env bash

source "${0%/*}/../bash/functions.sh"

dirs=(bin lib share/man/man1)
src_dir="/tmp"
install_dir="$HOME/.local"
elixir_version="v1.1.1"
elixir_archive="elixir-$elixir_version.zip"
elixir_src_dir="elixir-$elixir_version"
elixir_url="https://github.com/elixir-lang/elixir/releases/download/$elixir_version/Precompiled.zip"


function download_elixir() {
    log "Downloading $elixir_url into $src_dir ..."
	download "$elixir_url" "$src_dir/$elixir_archive" || return $?
}

function extract_elixir()
{
	log "Extracting $elixir_archive to $src_dir/$elixir_src_dir ..."
	unzip -o -q "$src_dir/$elixir_archive" -d "$src_dir/$elixir_src_dir" || return $?
}

function install_elixir()
{
    local dir

    log "Installing Elixir $elixir_version ..."

    for dir in "${dirs[@]}"; do
        mkdir -p "$install_dir/$dir" || return $?
    done

    cp -R $src_dir/$elixir_src_dir/bin/* "$install_dir/bin/" || return $?
    cp -R $src_dir/$elixir_src_dir/lib/* "$install_dir/lib/" || return $?
    cp -R $src_dir/$elixir_src_dir/man/*.1 "$install_dir/share/man/man1/" || return $?
}

log "Installing Elixir $elixir_version into $install_dir ..."

download_elixir || fail "Download of $elixir_url failed!"
extract_elixir || fail "Unpacking of $elixir_archive failed!"
install_elixir || fail "Installation of Elixir $elixir_version failed!"

log "Successfully installed Elixir $elixir_version into $install_dir"
